<!DOCTYPE html>
<html lang="en">
<head>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-G0XJG827K7"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-G0XJG827K7');
</script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Milky Player</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

    <style>
        body {
            margin: 0; background-color: #000; color: #ff0000;
            font-family: 'Press Start 2P', 'Consolas', monospace;
            overflow: hidden; user-select: none;
            -webkit-tap-highlight-color: transparent;
            font-size: 10px; 
            line-height: 1.5;
            cursor: url('curs.png'), auto;
        }
        
        button, .pointer, .tab, #progress-container, input[type=range], #mascot-img, #playlist-list li {
            cursor: url('curspoint.png'), pointer;
        }

        input[type=text] {
            cursor: url('curstext.png'), text;
        }

        #bg-video-container {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: -10; overflow: hidden; background: #000;
        }
        #bg-video {
            width: 100%; height: 100%; object-fit: cover; filter: brightness(0.4);
        }

        #screensaver-container {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: 99999; background: #000;
            opacity: 0; pointer-events: none; transition: opacity 1s ease;
        }
        #screensaver-video {
            width: 100%; height: 100%; object-fit: cover;
        }
        .screensaver-active {
            opacity: 1 !important; pointer-events: all !important;
        }

        .scanlines {
            position: fixed; left: 0; top: 0; width: 100vw; height: 100vh;
            pointer-events: none; z-index: 5000;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px;
            animation: scanlineAnim 0.2s linear infinite;
            opacity: 0.3;
        }

        @keyframes scanlineAnim {
            0% { transform: translateY(0); }
            100% { transform: translateY(4px); }
        }

        @keyframes slideInLeft {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes pulseGreen {
            0% { text-shadow: 0 0 5px #00ff00; opacity: 1; }
            50% { text-shadow: 0 0 15px #00ff00; opacity: 0.7; }
            100% { text-shadow: 0 0 5px #00ff00; opacity: 1; }
        }

        @keyframes modalPop {
            0% { transform: scale(0.8); opacity: 0; }
            60% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; pointer-events: none;
            flex-direction: row; transition: all 0.3s ease;
        }
        #left-panel {
            flex: 1; padding: 2rem; display: flex; flex-direction: column;
            pointer-events: auto; z-index: 10; min-width: 0;
            animation: slideInLeft 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }
        h1 {
            font-size: clamp(14px, 3vw, 24px); 
            color: #ff3333; text-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
            letter-spacing: 2px; margin: 0 0 10px 0; 
            overflow: hidden; white-space: nowrap; text-overflow: ellipsis;
        }
        .stat-text { font-size: 10px; color: #ff8888; font-weight: bold; margin-bottom: 5px; }
        .sub-stat { font-size: 8px; color: #884444; margin-bottom: 20px; }
        
        #live-users-display {
            color: #00ff00; animation: pulseGreen 3s infinite ease-in-out; margin-top: 5px;
        }

        #progress-container {
            width: 100%; height: 20px;
            background: #110000; border: 2px solid #440000;
            margin-bottom: 20px; position: relative;
            touch-action: none; transition: border-color 0.2s;
        }
        #progress-container:hover { border-color: #ff0000; box-shadow: 0 0 10px rgba(255,0,0,0.3); }

        #progress-fill {
            height: 100%; width: 0%; background: #ff0000;
            box-shadow: 0 0 10px #ff0000; transition: width 0.1s linear;
        }
        
        .gui-controls {
            margin-top: auto; display: flex; flex-direction: column; gap: 15px;
            transition: opacity 0.5s;
        }

        .btn-row { 
            display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-start;
        }
        button {
            background: linear-gradient(to bottom, #2a0000, #110000);
            color: #ff0000; border: 1px solid #880000; border-bottom: 3px solid #660000;
            padding: 12px 12px; font-family: inherit; font-size: 8px;
            border-radius: 4px; box-shadow: 0 0 5px rgba(255,0,0,0.1); transition: all 0.2s;
            text-transform: uppercase; flex-grow: 1; max-width: 120px;
            line-height: 1.5; position: relative; overflow: hidden;
        }
        button::after {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,0,0,0.2), transparent);
            transition: 0.5s;
        }
        button:hover::after { left: 100%; }
        button:hover { background: #440000; color: white; border-color: #ff3333; box-shadow: 0 0 15px rgba(255,0,0,0.6); transform: translateY(-1px); }
        button:active { transform: translateY(2px); border-bottom: 1px solid #660000; box-shadow: 0 0 5px rgba(255,0,0,0.3); }
        
        .slider-row { display: flex; gap: 20px; flex-wrap: wrap; }
        .slider-group { display: flex; flex-direction: column; align-items: flex-start; flex: 1; min-width: 120px;}
        input[type=range] { accent-color: #ff0000; width: 100%; height: 20px; transition: filter 0.2s; }
        input[type=range]:hover { filter: drop-shadow(0 0 5px rgba(255,0,0,0.5)); }

        #right-panel {
            width: 350px; background: rgba(5, 0, 0, 0.95);
            border-left: 1px solid #440000; box-shadow: -5px 0 30px rgba(100, 0, 0, 0.4);
            display: flex; flex-direction: column; pointer-events: auto;
            backdrop-filter: blur(10px);
            transition: transform 0.5s ease, opacity 0.5s ease;
            animation: slideInRight 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }
        
        .tabs { display: flex; background: #1a0000; border-bottom: 1px solid #440000; min-height: 45px; }
        .tab {
            flex: 1; padding: 0; display: flex; align-items: center; justify-content: center;
            border-right: 1px solid #440000; color: #880000; font-size: 8px; transition: all 0.2s;
        }
        .tab:hover { background: #2a0000; color: #ff5555; }
        .tab.active { background: #440000; color: #ff0000; box-shadow: inset 0 -3px 0 #ff0000; }
        .tab-content { padding: 15px; flex: 1; overflow-y: auto; display: none; }
        .tab-content.active { display: block; animation: slideInRight 0.3s ease-out; }
        
        #search-bar {
            width: 100%; background: #0a0000; border: 1px solid #660000;
            color: #ff0000; padding: 10px; font-family: inherit; margin-bottom: 10px;
            box-sizing: border-box; font-size: 10px; transition: box-shadow 0.2s;
        }
        #search-bar:focus { outline: none; box-shadow: 0 0 10px rgba(255,0,0,0.4); border-color: #ff0000; }

        #playlist-list { list-style: none; padding: 0; margin: 0; }
        #playlist-list li {
            padding: 12px; border-bottom: 1px solid #220000; font-size: 9px;
            color: #cc0000; overflow: hidden; 
            line-height: 1.5; transition: all 0.15s;
            display: flex; justify-content: space-between; align-items: center;
        }
        #playlist-list li:hover { background: rgba(50, 0, 0, 0.5); padding-left: 18px; color: #ff5555; }
        #playlist-list li.active { background: rgba(255, 0, 0, 0.2); border-left: 3px solid red; color: #ff8888; padding-left: 15px; }
        
        /* Delete Button */
        .delete-btn {
            color: #660000; font-weight: bold; padding: 2px 6px;
            border: 1px solid #440000; margin-left: 10px; transition: all 0.2s;
            background: #1a0000; font-size: 10px;
        }
        .delete-btn:hover { color: #ff0000; background: #330000; border-color: #ff0000; transform: scale(1.1); }

        .fx-group { border: 1px solid #440000; padding: 10px; margin-bottom: 12px; background: rgba(20,0,0,0.3); transition: border-color 0.2s; }
        .fx-group:hover { border-color: #880000; }
        .fx-title { color: #aa0000; margin-bottom: 5px; font-size: 8px; }
        .fx-control { display: flex; align-items: center; gap: 10px; }
        .fx-val { width: 45px; text-align: right; color: #ff8888; font-size: 8px; }
        
        #mascot-container {
            margin-top: 20px; width: 100%; display: flex; justify-content: center; align-items: center; padding-bottom: 20px;
        }
        #mascot-img {
            width: 200px; height: 200px; object-fit: contain; image-rendering: pixelated;
            border: 2px solid #440000; background: #000; transition: transform 0.1s, border-color 0.2s, box-shadow 0.2s;
        }
        #mascot-img:hover { border-color: #ff3333; box-shadow: 0 0 15px rgba(255,0,0,0.4); }
        #mascot-img:active { transform: scale(0.95); border-color: #ffffff; }

        canvas { position: absolute; top: 0; left: 0; z-index: 0; }
        #file-input { display: none; }
        #bg-folder-input { display: none; } 

        #exit-zen-btn {
            position: fixed; top: 20px; right: 20px; z-index: 1000;
            display: none; background: rgba(0,0,0,0.6); border: 1px solid #ff3333; color: #ff3333;
            padding: 10px 20px; border-radius: 4px; backdrop-filter: blur(5px);
            pointer-events: auto; animation: slideInRight 0.5s ease;
        }

        @media (max-width: 800px) {
            #ui-layer { flex-direction: column; }
            #left-panel { flex: 0 0 auto; padding: 20px; max-height: 40vh; animation: none; }
            #right-panel { width: 100%; flex: 1; border-left: none; border-top: 1px solid #440000; animation: none; }
            .gui-controls { margin-top: 10px; gap: 10px; }
            .btn-row { justify-content: space-between; gap: 8px; }
            button { padding: 10px; font-size: 8px; max-width: none; }
            h1 { font-size: 14px; }
        }

        body.clear-mode #right-panel { display: none !important; }
        body.clear-mode .gui-controls { opacity: 0; pointer-events: none; }
        body.clear-mode #time-display { opacity: 0; }
        body.clear-mode #exit-zen-btn { display: block; }
        
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0, 0, 0, 0.85);
            display: none; align-items: center; justify-content: center;
            z-index: 2000; pointer-events: auto; backdrop-filter: blur(2px);
        }
        .modal-window {
            width: min(500px, 90vw); max-height: 80vh;
            background: #0a0000; border: 2px solid #660000;
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.3);
            display: flex; flex-direction: column;
            animation: modalPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; background: #1a0000; border-bottom: 1px solid #440000;
            color: #ff3333; font-size: 9px;
        }
        .modal-close {
            background: none; border: none; color: #ff3333;
            font-family: inherit; cursor: pointer; font-size: 10px; transition: transform 0.2s;
        }
        .modal-close:hover { transform: scale(1.2); color: #fff; }
        .modal-content { padding: 15px; overflow-y: auto; font-size: 8px; line-height: 1.6; color: #ff8888; }
        
        .save-options { display: flex; flex-direction: column; gap: 10px; width: 100%; }
        .save-btn {
            padding: 15px; text-align: left; background: #110000; border: 1px solid #440000;
            color: #ff8888; transition: all 0.2s; width: 100%; max-width: none; display: block;
        }
        .save-btn:hover { background: #330000; border-color: red; color: white; transform: translateX(5px); }
        .save-desc { font-size: 6px; color: #884444; margin-top: 4px; }

        #render-progress-container {
            display: none; width: 100%; margin-top: 15px; background: #110000;
            border: 2px solid #440000; height: 20px; position: relative;
        }
        #render-progress-bar {
            width: 0%; height: 100%; background-color: #ff0000;
            transition: width 0.2s ease-out; box-shadow: 0 0 10px #ff0000;
        }
        #render-status-text {
            display: none; color: #ff8888; font-size: 8px; margin-top: 10px;
            text-align: center; width: 100%; animation: pulse 1s infinite;
        }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
    </style>
</head>
<body>
    <div id="screensaver-container">
        <video id="screensaver-video" src="screensaver.mp4" loop muted playsinline></video>
    </div>

    <div id="bg-video-container">
        <video id="bg-video" autoplay muted playsinline></video>
    </div>

    <div class="scanlines"></div>
    <canvas id="visCanvas"></canvas>
    <button id="exit-zen-btn" onclick="toggleZen()">Exit clear mode</button>

    <div id="ui-layer">
        <div id="left-panel">
            <h1 id="track-title">Nellix's Milkplayer</h1>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <div class="stat-text" id="time-display">00:00 / 00:00</div>
                <div class="stat-text" id="bpm-display">Bpm: ---</div>
            </div>
            
            <div class="stat-text" id="live-users-display">Drinking milk: ...</div>
            <div class="sub-stat" id="total-stats">You were on the site for: 00:00:00</div>
            
            <div id="progress-container" onclick="seekAudio(event)">
                <div id="progress-fill"></div>
            </div>

            <div class="gui-controls">
                <div class="btn-row">
                    <button onclick="playPrev()"><<</button>
                    <button id="btn-play" onclick="togglePlay()">PLAY</button>
                    <button onclick="playNext()">>></button>
                    <button onclick="toggleZen()">CM</button>
                    <button onclick="openModal('info')">:3с</button>
                    
                    <input type="file" id="file-input" accept="audio/*" multiple>
                    <button onclick="document.getElementById('file-input').click()">LOAD</button>
                    
                    <input type="file" id="bg-folder-input" webkitdirectory directory multiple>
                    <button onclick="document.getElementById('bg-folder-input').click()" title="Load folder for background music">BG MUSIC</button>
                    
                    <button onclick="openModal('save')">SAVE</button>
                </div>
                <div class="slider-row">
                    <div class="slider-group">
                        <label id="lbl-rate">Speed: 1.00x</label>
                        <input type="range" id="rate-slider" min="50" max="200" value="100" oninput="updateSpeed(this.value)">
                    </div>
                    <div class="slider-group">
                        <label id="lbl-vol">Volume: 100%</label>
                        <input type="range" id="vol-slider" min="0" max="150" value="100" oninput="updateVol(this.value)">
                    </div>
                </div>
            </div>
        </div>

        <div id="right-panel">
            <div class="tabs">
                <div class="tab" onclick="openTab('playlist')">Playlist</div>
                <div class="tab active" onclick="openTab('fx')">Effects</div>
                <div class="tab" onclick="openTab('vis')">Visuals</div>
            </div>
            <div id="tab-playlist" class="tab-content">
                <input type="text" id="search-bar" placeholder="SEARCH..." onkeyup="filterPlaylist()">
                <ul id="playlist-list"></ul>
            </div>
            <div id="tab-fx" class="tab-content active"></div>
            <div id="tab-vis" class="tab-content">
                <div class="fx-group">
                    <div class="fx-title">Effects</div>
                    <select id="vis-mode" style="width: 100%; background: #110000; color: red; border: 1px solid #440000; padding: 5px; font-family: inherit;" onchange="saveUserSettings()">
                        <option value="Waveform">Waveform</option>
                        <option value="Linear Bars">Bars thingy</option>
                        <option value="Circular Wave">Circle wave (lol??)</option>
                    </select>
                </div>
                <div class="fx-group">
                    <div class="fx-title">Settings</div>
                    <label><input type="checkbox" id="chk-particles" checked onchange="saveUserSettings()"> Show Particles</label><br>
                    <label><input type="checkbox" id="chk-mouse" checked onchange="saveUserSettings()"> Mouse Trail</label><br>
                </div>
            </div>
        </div>
    </div>

    <div id="info-overlay" class="modal-overlay" onclick="closeModal('info')">
        <div class="modal-window" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span>Nellix's Milkplayer</span>
                <button class="modal-close" onclick="closeModal('info')">:3</button>
            </div>
            <div class="modal-content">
                <p>Thank you for using this app! Updated with screensavers and cursors.</p>
                <p>Background Music: Click "BG MUSIC" and select a folder of MP3s. They will play when the main player stops.</p>
                <p>The site is being hosted at github https://github.com/shanewixx/milkplayer</p>
				<p>My socials: Discord - c6d31, Telegram - @nellix47</p>
            </div>
        </div>
    </div>

    <div id="save-overlay" class="modal-overlay" onclick="closeModal('save')">
        <div class="modal-window" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span>Save your edited audio</span>
                <button class="modal-close" onclick="closeModal('save')">X</button>
            </div>
            <div class="modal-content">
                <p style="margin-bottom: 15px; color: #ffaaaa;" id="save-prompt-text">I have several formats for you</p>
                <div class="save-options">
                    <button class="save-btn" onclick="instantSave('wav')">WAV <div class="save-desc">Lossless quality</div></button>
                    <button class="save-btn" onclick="instantSave('mp3')">MP3 <div class="save-desc">Standard compressed</div></button>
                    <button class="save-btn" onclick="instantSave('ogg')">OGG <div class="save-desc">Open source format</div></button>
                </div>
                <div id="render-progress-container">
                    <div id="render-progress-bar"></div>
                </div>
                <div id="render-status-text">RENDERING AUDIO...</div>
            </div>
        </div>
    </div>

    <script>
        const clickSound = new Audio('1.ogg');
        const fxSound = new Audio('fx.ogg');
        
        document.addEventListener('click', (e) => {
            if(e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                clickSound.currentTime = 0;
                clickSound.volume = 0.4;
                clickSound.play().catch(()=>{});
            }
        });

        document.addEventListener('input', (e) => {
            if(e.target.type === 'range') {
                fxSound.currentTime = 0;
                fxSound.volume = 0.2;
                fxSound.play().catch(()=>{});
            }
        });

        let idleTime = 0;
        const screensaverContainer = document.getElementById('screensaver-container');
        const screensaverVideo = document.getElementById('screensaver-video');
        
        function resetIdleTimer() {
            idleTime = 0;
            if(screensaverContainer.classList.contains('screensaver-active')) {
                screensaverContainer.classList.remove('screensaver-active');
                screensaverVideo.pause();
            }
        }

        setInterval(() => {
            idleTime++;
            if (idleTime >= 300) { 
                if(!screensaverContainer.classList.contains('screensaver-active')) {
                    screensaverContainer.classList.add('screensaver-active');
                    screensaverVideo.play().catch(e => console.log("Screensaver autoplay blocked"));
                }
            }
        }, 1000);

        ['mousemove', 'mousedown', 'keydown', 'touchstart'].forEach(evt => 
            document.addEventListener(evt, resetIdleTimer)
        );

        let bgMusicFiles = [];
        let bgAudio = new Audio();
        let bgMusicPlaying = false;
        let bgFadeInterval;

        document.getElementById('bg-folder-input').addEventListener('change', (e) => {
            bgMusicFiles = Array.from(e.target.files).filter(f => f.type.startsWith('audio/'));
            if(bgMusicFiles.length > 0) {
                alert(`Loaded ${bgMusicFiles.length} background tracks. They will play when you pause.`);
                if(!isPlaying) playBgMusic();
            } else {
                alert("No audio files found in that folder.");
            }
        });

        function playBgMusic() {
            if(bgMusicFiles.length === 0 || isPlaying) return;
            
            const file = bgMusicFiles[Math.floor(Math.random() * bgMusicFiles.length)];
            const url = URL.createObjectURL(file);
            bgAudio.src = url;
            bgAudio.volume = 0;
            bgAudio.loop = false;
            bgAudio.play().catch(e => console.log("BG Audio block", e));
            bgMusicPlaying = true;
            
            clearInterval(bgFadeInterval);
            bgFadeInterval = setInterval(() => {
                if(bgAudio.volume < 0.5) bgAudio.volume = Math.min(0.5, bgAudio.volume + 0.05);
                else clearInterval(bgFadeInterval);
            }, 200);

            bgAudio.onended = () => {
                if(!isPlaying) playBgMusic();
            };
        }

        function stopBgMusic() {
            if(!bgMusicPlaying) return;
            clearInterval(bgFadeInterval);
            bgFadeInterval = setInterval(() => {
                if(bgAudio.volume > 0.05) bgAudio.volume -= 0.05;
                else {
                    bgAudio.pause();
                    bgMusicPlaying = false;
                    clearInterval(bgFadeInterval);
                }
            }, 100);
        }

        const bgVideo = document.getElementById('bg-video');
        const videoSources = ['milk1.mp4', 'milk2.mp4', 'milk3.mp4'];
        let currentVideoIndex = 0;

        function playNextBgVideo() {
            bgVideo.src = videoSources[currentVideoIndex];
            bgVideo.play().catch(e => console.log("Video autoplay blocked", e));
            currentVideoIndex = (currentVideoIndex + 1) % videoSources.length;
        }
        bgVideo.addEventListener('ended', playNextBgVideo);
        playNextBgVideo();

        const canvas = document.getElementById('visCanvas');
        const ctx = canvas.getContext('2d');
        let width, height, cx, cy;
        let audioCtx, sourceNode, analyser;
        let gainMaster, distNode, lpNode, tremoloGain, tremoloOsc, delayNode, delayFB, delayWet, revNode, revWet;
        let playlist = [];
        let currentTrackIndex = -1;
        let audioBuffer = null;
        let isPlaying = false;
        let playbackRate = 1.0;
        let volume = 1.0;
        let songStartOffset = 0;
        let anchorTime = 0;
        let dataArray, waveArray;
        let bassEnergy = 0;
        let particles = [], mouseParticles = [];
        let sessionStart = Date.now();
        let lastBeat = 0;

        function saveUserSettings() {
            const settings = {
                volume: document.getElementById('vol-slider').value,
                rate: document.getElementById('rate-slider').value,
                visMode: document.getElementById('vis-mode').value,
                showParticles: document.getElementById('chk-particles').checked,
                mouseTrail: document.getElementById('chk-mouse').checked,
                fx: {
                    echo: document.querySelector('#tab-fx .fx-group:nth-child(1) input')?.value || 0,
                    reverb: document.querySelector('#tab-fx .fx-group:nth-child(2) input')?.value || 0,
                    dist: document.querySelector('#tab-fx .fx-group:nth-child(3) input')?.value || 0,
                    lp: document.querySelector('#tab-fx .fx-group:nth-child(4) input')?.value || 0,
                    trem: document.querySelector('#tab-fx .fx-group:nth-child(5) input')?.value || 0
                }
            };
            localStorage.setItem('milkplayer_settings', JSON.stringify(settings));
        }

        function loadUserSettings() {
            const saved = localStorage.getItem('milkplayer_settings');
            if (!saved) return;
            try {
                const s = JSON.parse(saved);
                if(s.volume) { document.getElementById('vol-slider').value = s.volume; updateVol(s.volume); }
                if(s.rate) { document.getElementById('rate-slider').value = s.rate; updateSpeed(s.rate); }
                if(s.visMode) document.getElementById('vis-mode').value = s.visMode;
                if(s.showParticles !== undefined) document.getElementById('chk-particles').checked = s.showParticles;
                if(s.mouseTrail !== undefined) document.getElementById('chk-mouse').checked = s.mouseTrail;
                
                const fxInputs = document.querySelectorAll('#tab-fx input[type=range]');
                if(fxInputs.length >= 5 && s.fx) {
                    if(s.fx.echo) { fxInputs[0].value = s.fx.echo; setFX('echo', s.fx.echo); }
                    if(s.fx.reverb) { fxInputs[1].value = s.fx.reverb; setFX('reverb', s.fx.reverb); }
                    if(s.fx.dist) { fxInputs[2].value = s.fx.dist; setFX('dist', s.fx.dist); }
                    if(s.fx.lp) { fxInputs[3].value = s.fx.lp; setFX('lp', s.fx.lp); }
                    if(s.fx.trem) { fxInputs[4].value = s.fx.trem; setFX('trem', s.fx.trem); }
                }
            } catch (e) { console.error(e); }
        }

        function toggleZen() {
            document.body.classList.toggle('clear-mode');
        }
        
        document.addEventListener('keydown', (e) => {
            if (e.key === "Control") toggleZen();
            if (e.key === "Escape") { closeModal('info'); closeModal('save'); }
        });

        function openModal(id) {
            document.getElementById(id + '-overlay').style.display = 'flex';
            if(id === 'save') {
                document.querySelector('.save-options').style.display = 'flex';
                document.getElementById('render-progress-container').style.display = 'none';
                document.getElementById('render-status-text').style.display = 'none';
                document.getElementById('save-prompt-text').innerText = "I have several formats for you";
                document.getElementById('render-progress-bar').style.width = '0%';
            }
        }
        function closeModal(id) {
            document.getElementById(id + '-overlay').style.display = 'none';
        }

        function initAudio() {
            if (audioCtx) return;
            const AC = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AC();
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 4096;
            analyser.smoothingTimeConstant = 0.85;
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            waveArray = new Float32Array(analyser.fftSize);
            gainMaster = audioCtx.createGain();
            gainMaster.gain.value = volume;
            
            distNode = audioCtx.createWaveShaper();
            distNode.curve = makeDistortionCurve(0);
            distNode.oversample = '4x';
            
            lpNode = audioCtx.createBiquadFilter();
            lpNode.type = "lowpass";
            lpNode.frequency.value = 22000;
            
            tremoloGain = audioCtx.createGain();
            tremoloOsc = audioCtx.createOscillator();
            tremoloOsc.frequency.value = 4;
            tremoloOsc.start();
            const lfoAmp = audioCtx.createGain();
            lfoAmp.gain.value = 0;
            tremoloOsc.connect(lfoAmp).connect(tremoloGain.gain);
            window.lfoAmp = lfoAmp;
            
            delayNode = audioCtx.createDelay(5.0);
            delayNode.delayTime.value = 0.4;
            delayFB = audioCtx.createGain();
            delayFB.gain.value = 0.4;
            delayWet = audioCtx.createGain();
            delayWet.gain.value = 0;
            delayNode.connect(delayFB).connect(delayNode);
            
            revNode = audioCtx.createConvolver();
            revNode.buffer = createImpulse(2.0);
            revWet = audioCtx.createGain();
            revWet.gain.value = 0;
        }

        function createImpulse(duration) {
            const rate = audioCtx.sampleRate;
            const len = rate * duration;
            const buf = audioCtx.createBuffer(2, len, rate);
            for (let i = 0; i < 2; i++) {
                const ch = buf.getChannelData(i);
                for (let j = 0; j < len; j++) {
                    ch[j] = (Math.random() * 2 - 1) * Math.pow(1 - j / len, 2);
                }
            }
            return buf;
        }

        function makeDistortionCurve(k) {
            const n = 44100, curve = new Float32Array(n), deg = Math.PI / 180;
            for (let i = 0; i < n; ++i) {
                let x = i * 2 / n - 1;
                curve[i] = (3 + k) * x * 20 * deg / (Math.PI + k * Math.abs(x));
            }
            return curve;
        }

        async function loadTrack(index) {
            if (index < 0 || index >= playlist.length) return;
            initAudio();
            stopBgMusic();
            
            currentTrackIndex = index;
            updatePlaylistUI();
            const file = playlist[index];
            document.getElementById('track-title').innerText = "LOADING: " + file.name.toUpperCase();
            const reader = new FileReader();
            reader.onload = e => {
                audioCtx.decodeAudioData(e.target.result, buffer => {
                    audioBuffer = buffer;
                    document.getElementById('track-title').innerText = file.name.toUpperCase();
                    songStartOffset = 0;
                    playAudio();
                });
            };
            reader.readAsArrayBuffer(file);
        }

        function playAudio() {
            if (!audioBuffer) return;
            if (sourceNode) {
                sourceNode.onended = null;
                try { sourceNode.stop(); } catch(e){}
                sourceNode.disconnect();
            }
            sourceNode = audioCtx.createBufferSource();
            sourceNode.buffer = audioBuffer;
            sourceNode.playbackRate.value = playbackRate;
            
            // Connect Graph
            sourceNode.connect(distNode);
            distNode.connect(lpNode);
            lpNode.connect(tremoloGain);
            tremoloGain.connect(gainMaster);
            
            // Sends
            sourceNode.connect(delayNode).connect(delayWet).connect(gainMaster);
            sourceNode.connect(revNode).connect(revWet).connect(gainMaster);
            
            gainMaster.connect(analyser);
            analyser.connect(audioCtx.destination);
            
            anchorTime = audioCtx.currentTime;
            sourceNode.start(0, songStartOffset);
            isPlaying = true;
            document.getElementById('btn-play').innerText = "PAUSE";
            
            stopBgMusic();

            sourceNode.onended = () => {
                playNext();
            };
        }

        function togglePlay() {
            if (!audioBuffer) {
                if (playlist.length > 0) loadTrack(0);
                return;
            }
            if (isPlaying) {
                const now = audioCtx.currentTime;
                songStartOffset = songStartOffset + (now - anchorTime) * playbackRate;
                audioCtx.suspend();
                isPlaying = false;
                document.getElementById('btn-play').innerText = "RESUME";
                playBgMusic(); // Start ambient
            } else {
                anchorTime = audioCtx.currentTime;
                audioCtx.resume();
                isPlaying = true;
                document.getElementById('btn-play').innerText = "PAUSE";
                stopBgMusic(); // Stop ambient
            }
        }

        function seekAudio(e) {
            if (!audioBuffer) return;
            const rect = document.getElementById('progress-container').getBoundingClientRect();
            const x = e.clientX - rect.left;
            const ratio = Math.max(0, Math.min(1, x / rect.width));
            songStartOffset = ratio * audioBuffer.duration;
            if (isPlaying) playAudio();
            else document.getElementById('progress-fill').style.width = (ratio*100) + "%";
        }

        function updateSpeed(val) {
            const newRate = val / 100;
            if (isPlaying && audioBuffer) {
                const now = audioCtx.currentTime;
                const currentPos = songStartOffset + (now - anchorTime) * playbackRate;
                songStartOffset = currentPos;
                anchorTime = now;
            }
            playbackRate = newRate;
            document.getElementById('lbl-rate').innerText = `Speed: ${playbackRate.toFixed(2)}x`;
            if (sourceNode) sourceNode.playbackRate.value = playbackRate;
            saveUserSettings();
        }

        function updateVol(val) {
            volume = val / 100;
            document.getElementById('lbl-vol').innerText = `Volume: ${val}%`;
            if (gainMaster) gainMaster.gain.value = volume;
            saveUserSettings();
        }

        function playNext() {
            if (playlist.length === 0) return;
            let next = (currentTrackIndex + 1) % playlist.length;
            loadTrack(next);
        }
        function playPrev() {
            if (playlist.length === 0) return;
            let prev = (currentTrackIndex - 1 + playlist.length) % playlist.length;
            loadTrack(prev);
        }

        function bufferToWave(abuffer, len) {
            let numOfChan = abuffer.numberOfChannels, length = len * numOfChan * 2 + 44,
                buffer = new ArrayBuffer(length), view = new DataView(buffer), channels = [], i, sample, offset = 0, pos = 0;
            
            function setUint16(data) { view.setUint16(pos, data, true); pos += 2; }
            function setUint32(data) { view.setUint32(pos, data, true); pos += 4; }

            setUint32(0x46464952); setUint32(length - 8); setUint32(0x45564157);
            setUint32(0x20746d66); setUint32(16); setUint16(1); setUint16(numOfChan);
            setUint32(abuffer.sampleRate); setUint32(abuffer.sampleRate * 2 * numOfChan);
            setUint16(numOfChan * 2); setUint16(16); setUint32(0x61746164);
            setUint32(length - pos - 4);

            for(i = 0; i < abuffer.numberOfChannels; i++) channels.push(abuffer.getChannelData(i));
            while(pos < len) {
                for(i = 0; i < numOfChan; i++) {
                    sample = Math.max(-1, Math.min(1, channels[i][pos])); 
                    sample = (0.5 + sample < 0 ? sample * 32768 : sample * 32767)|0; 
                    view.setInt16(44 + offset, sample, true); offset += 2;
                }
                pos++;
            }
            return new Blob([buffer], {type: "audio/wav"});
        }

        async function instantSave(format) {
            if (!audioBuffer) { alert("You loaded no music bro"); return; }
            document.getElementById('save-prompt-text').innerText = "Applying effects...";
            document.querySelector('.save-options').style.display = 'none';
            document.getElementById('render-progress-container').style.display = 'block';
            document.getElementById('render-status-text').style.display = 'block';

            let fakeProgress = 0;
            const progBar = document.getElementById('render-progress-bar');
            const progInt = setInterval(() => { fakeProgress += (90 - fakeProgress) * 0.1; progBar.style.width = fakeProgress + "%"; }, 100);

            await new Promise(r => setTimeout(r, 100)); // UI refresh
            
            const sr = audioCtx.sampleRate;
            const dur = audioBuffer.duration / playbackRate;
            const offlineCtx = new OfflineAudioContext(2, dur * sr, sr);
            
            const src = offlineCtx.createBufferSource();
            src.buffer = audioBuffer;
            src.playbackRate.value = playbackRate;

            const dist = offlineCtx.createWaveShaper();
            dist.curve = makeDistortionCurve(document.querySelector('#tab-fx .fx-group:nth-child(3) input').value * 4);
            
            const lp = offlineCtx.createBiquadFilter();
            lp.type = "lowpass";
            const lpVal = document.querySelector('#tab-fx .fx-group:nth-child(4) input').value / 100;
            lp.frequency.value = lpVal === 0 ? 22000 : 22000 * Math.pow(0.02, lpVal);

            const tmGain = offlineCtx.createGain();
            const tmOsc = offlineCtx.createOscillator();
            tmOsc.frequency.value = 4;
            const lfo = offlineCtx.createGain();
            lfo.gain.value = document.querySelector('#tab-fx .fx-group:nth-child(5) input').value / 100;
            tmOsc.connect(lfo).connect(tmGain.gain);
            tmOsc.start();

            const dNode = offlineCtx.createDelay(5);
            dNode.delayTime.value = 0.4;
            const dFb = offlineCtx.createGain(); dFb.gain.value = 0.4;
            const dWet = offlineCtx.createGain();
            dWet.gain.value = document.querySelector('#tab-fx .fx-group:nth-child(1) input').value / 100;
            dNode.connect(dFb).connect(dNode);

            const rNode = offlineCtx.createConvolver();
            rNode.buffer = revNode.buffer;
            const rWet = offlineCtx.createGain();
            rWet.gain.value = document.querySelector('#tab-fx .fx-group:nth-child(2) input').value / 100;

            const master = offlineCtx.createGain();
            master.gain.value = volume;

            src.connect(dist).connect(lp).connect(tmGain).connect(master);
            src.connect(dNode).connect(dWet).connect(master);
            src.connect(rNode).connect(rWet).connect(master);
            master.connect(offlineCtx.destination);
            src.start(0);

            const rendered = await offlineCtx.startRendering();
            clearInterval(progInt);
            progBar.style.width = "100%";
            
            const blob = bufferToWave(rendered, rendered.length);
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `rendered_${Date.now()}.${format === 'wav' ? 'wav' : 'wav'}`; // Simplified export
            a.click();
            setTimeout(() => closeModal('save'), 1000);
        }

        // File handling
        document.body.addEventListener('dragover', e => e.preventDefault());
        document.body.addEventListener('drop', e => {
            e.preventDefault();
            addFiles(e.dataTransfer.files);
        });
        document.getElementById('file-input').addEventListener('change', e => addFiles(e.target.files));

        function addFiles(files) {
            for (let f of files) playlist.push(f);
            updatePlaylistUI();
            if (currentTrackIndex === -1 && playlist.length > 0) loadTrack(0);
        }

        // NEW: Remove Track Function
        window.removeTrack = (index) => {
            if (index === currentTrackIndex) {
                if (sourceNode) { try { sourceNode.stop(); } catch(e){} }
                isPlaying = false;
                currentTrackIndex = -1;
                audioBuffer = null;
                document.getElementById('track-title').innerText = "Nellix's Milkplayer";
                document.getElementById('btn-play').innerText = "PLAY";
                document.getElementById('progress-fill').style.width = "0%";
                document.getElementById('time-display').innerText = "00:00 / 00:00";
                playBgMusic(); // Resume ambient
            } else if (index < currentTrackIndex) {
                currentTrackIndex--;
            }
            playlist.splice(index, 1);
            updatePlaylistUI();
        };

        function updatePlaylistUI() {
            const list = document.getElementById('playlist-list');
            const filter = document.getElementById('search-bar').value.toLowerCase();
            list.innerHTML = "";
            playlist.forEach((file, idx) => {
                if (file.name.toLowerCase().includes(filter)) {
                    const li = document.createElement('li');
                    if (idx === currentTrackIndex) li.className = 'active';
                    
                    const span = document.createElement('span');
                    span.innerText = file.name;
                    span.style.flex = "1";
                    span.style.overflow = "hidden";
                    span.style.textOverflow = "ellipsis";
                    span.style.whiteSpace = "nowrap";

                    // Use Ø as requested
                    const del = document.createElement('span');
                    del.innerText = "Ø"; 
                    del.className = "delete-btn";
                    del.onclick = (e) => { e.stopPropagation(); removeTrack(idx); };

                    li.appendChild(span);
                    li.appendChild(del);
                    li.ondblclick = () => loadTrack(idx);
                    li.ontouchstart = () => loadTrack(idx);
                    list.appendChild(li);
                }
            });
        }
        window.filterPlaylist = updatePlaylistUI;

        // FX Generation
        const fxConfig = [
            { id: 'echo', name: 'ECHO (DELAY)', def: 0 },
            { id: 'reverb', name: 'REVERB (SPACE)', def: 0 },
            { id: 'dist', name: 'DISTORTION', def: 0 },
            { id: 'lp', name: 'MUFFLE (LP)', def: 0 },
            { id: 'trem', name: 'PULSE (TREMOLO)', def: 0 }
        ];

        const fxCont = document.getElementById('tab-fx');
        fxConfig.forEach(fx => {
            const div = document.createElement('div');
            div.className = 'fx-group';
            div.innerHTML = `
                <div class="fx-title">${fx.name}</div>
                <div class="fx-control">
                    <input type="range" min="0" max="100" value="${fx.def}" oninput="setFX('${fx.id}', this.value)" onchange="saveUserSettings()">
                    <div class="fx-val" id="val-${fx.id}">${fx.def}%</div>
                </div>`;
            fxCont.appendChild(div);
        });

        window.setFX = (id, val) => {
            document.getElementById(`val-${id}`).innerText = val + "%";
            if (!audioCtx) return;
            const v = val / 100;
            const t = audioCtx.currentTime;
            if (id === 'echo') delayWet.gain.setTargetAtTime(v, t, 0.1);
            if (id === 'reverb') revWet.gain.setTargetAtTime(v, t, 0.1);
            if (id === 'dist') distNode.curve = makeDistortionCurve(val * 4);
            if (id === 'lp') {
                const freq = v === 0 ? 22000 : 22000 * Math.pow(0.02, v);
                lpNode.frequency.setTargetAtTime(freq, t, 0.1);
            }
            if (id === 'trem') window.lfoAmp.gain.setTargetAtTime(v, t, 0.1);
        };

        // Canvas/Visuals
        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            cx = window.innerWidth / 2;
            cy = height / 2;
        }
        window.addEventListener('resize', resize);
        resize();

        class Particle {
            constructor(isMouse, mx, my) {
                this.isMouse = isMouse;
                this.reset(mx, my, true);
            }
            reset(mx, my, first) {
                if (this.isMouse) {
                    this.x = mx + (Math.random()*4-2); this.y = my;
                    this.size = Math.random()*3+1; this.speed = Math.random()*2+1;
                    this.life = 1.0;
                } else {
                    this.x = Math.random()*width;
                    this.y = first ? Math.random()*height : -10;
                    this.size = Math.random()*3+1;
                    this.speed = Math.random()*1.5+0.5;
                    this.baseOp = Math.random()*0.4+0.1;
                    this.op = this.baseOp;
                }
            }
            update(bass) {
                this.y += this.speed * (1 + bass * 0.5);
                if (this.isMouse) {
                    this.life -= 0.02;
                } else {
                    this.op = this.baseOp + (bass * 0.4);
                    if (this.y > height) this.reset();
                }
            }
            draw(ctx) {
                const alpha = this.isMouse ? this.life : this.op;
                ctx.fillStyle = `rgba(${this.isMouse?'255,50,50':'200,0,0'}, ${alpha})`;
                ctx.fillRect(this.x, this.y, this.size, this.size);
            }
        }
        for(let i=0; i<120; i++) particles.push(new Particle(false));

        document.addEventListener('mousemove', e => {
            if (document.getElementById('chk-mouse').checked) {
                mouseParticles.push(new Particle(true, e.clientX, e.clientY));
            }
        });

        function render() {
            requestAnimationFrame(render);
            ctx.clearRect(0, 0, width, height);
            
            let curr = 0; let dur = 1;
            if (isPlaying && !audioCtx.paused && audioBuffer) {
                analyser.getByteFrequencyData(dataArray);
                analyser.getFloatTimeDomainData(waveArray);
                const now = audioCtx.currentTime;
                curr = songStartOffset + (now - anchorTime) * playbackRate;
                dur = audioBuffer.duration;
                if (curr > dur) curr = dur;
                if (dur > 0) {
                    document.getElementById('progress-fill').style.width = ((curr/dur)*100) + "%";
                    const fmt = t => `${Math.floor(t/60).toString().padStart(2,'0')}:${Math.floor(t%60).toString().padStart(2,'0')}`;
                    document.getElementById('time-display').innerText = `${fmt(curr)} / ${fmt(dur)}`;
                }
                let bSum = 0;
                for(let i=0; i<20; i++) bSum += dataArray[i];
                bassEnergy = (bSum / 20) / 255;
                if (bassEnergy > 0.7 && Date.now() - lastBeat > 400) {
                    const bpm = 120 + Math.floor(Math.random()*10 - 5);
                    document.getElementById('bpm-display').innerText = `BPM: ${bpm}`;
                    lastBeat = Date.now();
                }
            } else {
                bassEnergy *= 0.9;
            }

            const mode = document.getElementById('vis-mode').value;
            if (mode === "Linear Bars") {
                const count = 100; const barW = (width - (width*0.1)) / count;
                for(let i=0; i<count; i++) {
                    const v = dataArray[i*2];
                    const h = (v/255) * (height*0.6);
                    ctx.fillStyle = `rgba(${v+50}, 0, 0, 0.9)`;
                    ctx.fillRect((width*0.05) + i*barW, height-h-50, barW-1, h);
                }
            }
            else if (mode === "Circular Wave") {
                const rad = Math.min(width, height) * 0.25;
                ctx.strokeStyle = `rgba(255, 20, 20, 0.8)`; ctx.lineWidth = 3;
                ctx.beginPath();
                for(let i=0; i<180; i++) {
                    const ang = (i / 90) * Math.PI;
                    const v = dataArray[i] / 255.0;
                    const r = rad + (v * 200 * bassEnergy);
                    const x = cx + Math.cos(ang) * r;
                    const y = cy + Math.sin(ang) * r;
                    if (i===0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                }
                ctx.closePath(); ctx.stroke();
            }
            else if (mode === "Waveform") {
                if (waveArray) {
                    ctx.lineWidth = 4; ctx.strokeStyle = "#ff3333";
                    ctx.shadowBlur = 20; ctx.shadowColor = "#ff0000";
                    ctx.beginPath();
                    const sliceW = width / waveArray.length;
                    let x = 0;
                    for(let i = 0; i < waveArray.length; i+=4) {
                        const v = waveArray[i];
                        const y = cy + (v * (height * 0.6));
                        if(i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                        x += sliceW * 4;
                    }
                    ctx.stroke();
                    ctx.shadowBlur = 0;
                }
            }
            
            if (document.getElementById('chk-particles').checked) {
                particles.forEach(p => { p.update(bassEnergy); p.draw(ctx); });
            }
            mouseParticles.forEach((p, i) => {
                p.update(bassEnergy); p.draw(ctx);
                if (p.life <= 0) mouseParticles.splice(i,1);
            });
            
            const diff = Math.floor((Date.now()-sessionStart)/1000);
            const hh = Math.floor(diff/3600).toString().padStart(2,'0');
            const mm = Math.floor((diff%3600)/60).toString().padStart(2,'0');
            const ss = (diff%60).toString().padStart(2,'0');
            document.getElementById('total-stats').innerText = `You were listening for: ${hh}:${mm}:${ss}`;
        }
        render();

        function initLiveCounter() {
            if (window._milkplayer_livecounter_initialized) return;
            window._milkplayer_livecounter_initialized = true;
            try {
                if (typeof firebase !== 'undefined' && (!firebase.apps || firebase.apps.length === 0)) {
                    firebase.initializeApp({
                        apiKey: "AIzaSyDI7hLOPe1H-XIRfk7vDzoNbnE7zZxk7IQ",
                        authDomain: "milkplayer-5ce5e.firebaseapp.com",
                        databaseURL: "https://milkplayer-5ce5e-default-rtdb.firebaseio.com",
                        projectId: "milkplayer-5ce5e",
                        storageBucket: "milkplayer-5ce5e.firebasestorage.app",
                        messagingSenderId: "765396954514",
                        appId: "1:765396954514:web:3e8d17c1f0ce1d5119e54b"
                    });
                    const db = firebase.database();
                    const presenceRef = db.ref('connections');
                    const connectedRef = db.ref('.info/connected');
                    const myCon = presenceRef.push();
                    connectedRef.on('value', (snap) => {
                        if (snap.val() === true) { myCon.onDisconnect().remove(); myCon.set(true); }
                    });
                    presenceRef.on('value', (snap) => {
                        const count = snap.numChildren();
                        const el = document.getElementById('live-users-display');
                        if (el) el.innerText = `Drinking milk: ${count}`;
                    });
                }
            } catch (e) { console.error('Firebase Error', e); }
        }

        window.addEventListener('load', () => {
            try { loadUserSettings(); } catch (e) { console.warn(e); }
            try { initLiveCounter(); } catch (e) { console.warn(e); }
            const fxTab = document.getElementById('tab-fx');
            const container = document.createElement('div');
            container.id = 'mascot-container';
            const img = document.createElement('img');
            img.id = 'mascot-img';
            img.src = '1.png';
            let currentImgIndex = 1;
            img.addEventListener('click', () => {
                currentImgIndex = (currentImgIndex % 5) + 1;
                img.src = `${currentImgIndex}.png`;
                const snd = new Audio(Math.random() > 0.5 ? '1.ogg' : '2.ogg');
                snd.volume = 0.2;
                snd.playbackRate = 0.5 + Math.random();
                snd.play().catch(()=>{});
            });
            container.appendChild(img);
            fxTab.appendChild(container);
        });
    </script>
</body>
</html>
